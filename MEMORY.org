#+TITLE: Sage Memory System
#+AUTHOR: Jason Walsh
#+DATE: 2024-12-23

* Overview

The =sage-memory= package provides a persistent memory/facts system for the sage. It allows the AI to remember facts about you, your preferences, projects, and technical details across sessions.

* Features

- *Persistent Storage*: Facts are stored in JSON format at =~/.emacs.d/sage/memory/facts.json=
- *Categorization*: Organize facts into general, preference, project, or technical categories
- *Automatic Timestamping*: Each fact includes when it was created/updated
- *Context Generation*: Automatically inject facts into conversation context
- *Interactive Management*: Add, remove, list, and search facts interactively

* Installation

The memory system is automatically available when you use =sage=. Just ensure =sage-memory.el= is in your load path.

#+begin_src emacs-lisp
(require 'sage-memory)
#+end_src

* Usage

** Adding Facts

*** Interactively
#+begin_src emacs-lisp
M-x sage-memory-add
#+end_src

You'll be prompted for:
1. Fact key (unique identifier)
2. Fact value
3. Category (general, preference, project, technical)

*** Programmatically
#+begin_src emacs-lisp
;; Add a preference
(sage-memory-add "editor" "Emacs" 'preference)

;; Add a project fact
(sage-memory-add "current-project" "sage" 'project)

;; Add technical knowledge
(sage-memory-add "language" "Emacs Lisp" 'technical)

;; Add general information (default category)
(sage-memory-add "name" "Alice")
#+end_src

** Retrieving Facts

#+begin_src emacs-lisp
;; Get a fact
(sage-memory-get "editor")
;; => (:key "editor" :value "Emacs" :category preference :timestamp "2024-12-23T...")

;; Interactively view a fact
M-x sage-memory-get
#+end_src

** Listing Facts

#+begin_src emacs-lisp
;; List all facts
(sage-memory-list)

;; List facts by category
(sage-memory-list 'preference)
(sage-memory-list 'project)

;; Interactively
M-x sage-memory-list        ;; All facts
C-u M-x sage-memory-list    ;; Select category
#+end_src

** Removing Facts

#+begin_src emacs-lisp
;; Remove a fact
(sage-memory-remove "editor")

;; Interactively (with completion)
M-x sage-memory-remove
#+end_src

** Clearing All Facts

#+begin_src emacs-lisp
;; Clear all facts (prompts for confirmation)
M-x sage-memory-clear
#+end_src

** Generating Context

The memory system automatically generates context for the AI when starting a new conversation:

#+begin_src emacs-lisp
;; Generate context string from all facts
(sage-memory-to-context)
#+end_src

This returns a formatted string like:

#+begin_example
# Stored Facts

The following facts have been learned about the user and their environment:

## Preference

- editor: Emacs
- theme: dark

## Project

- current-project: sage
- language: Emacs Lisp

## Technical

- os: FreeBSD
- shell: zsh
#+end_example

* Configuration

** Auto-loading

#+begin_src emacs-lisp
;; Automatically load facts from disk on first access (default: t)
(setq sage-memory-auto-load t)
#+end_src

** Auto-saving

#+begin_src emacs-lisp
;; Automatically save facts after modifications (default: t)
(setq sage-memory-auto-save t)
#+end_src

** Storage Location

#+begin_src emacs-lisp
;; Change where facts are stored
(setq sage-memory-file
      (expand-file-name "my-facts.json" user-emacs-directory))
#+end_src

** Enable/Disable Memory in Conversations

#+begin_src emacs-lisp
;; Include memory context in conversations (default: t)
(setq sage-use-memory t)

;; Disable memory context
(setq sage-use-memory nil)
#+end_src

* Categories

Facts are organized into four categories:

1. *general*: General information about the user
2. *preference*: User preferences (editor, theme, workflow)
3. *project*: Project-specific information
4. *technical*: Technical knowledge and environment details

* Data Structure

Each fact is stored as a plist with the following keys:

- =:key= - Unique identifier (string)
- =:value= - Fact value (string)
- =:category= - Category symbol (general, preference, project, technical)
- =:timestamp= - ISO 8601 timestamp (string)

Example:
#+begin_src emacs-lisp
(:key "editor"
 :value "Emacs"
 :category preference
 :timestamp "2024-12-23T14:30:00-0800")
#+end_src

* JSON Storage Format

Facts are persisted as JSON:

#+begin_src json
[
  {
    "key": "editor",
    "value": "Emacs",
    "category": "preference",
    "timestamp": "2024-12-23T14:30:00-0800"
  },
  {
    "key": "current-project",
    "value": "sage",
    "category": "project",
    "timestamp": "2024-12-23T14:31:00-0800"
  }
]
#+end_src

* Integration with sage

When =sage-use-memory= is enabled (default), the memory context is automatically injected at the start of new conversations. This allows the AI to have context about:

- Your preferences
- Current projects
- Technical environment
- Previous learnings

* Example Workflow

#+begin_src emacs-lisp
;; Initial setup - teach the AI about yourself
(sage-memory-add "name" "Alice" 'general)
(sage-memory-add "editor" "Emacs" 'preference)
(sage-memory-add "os" "FreeBSD" 'technical)
(sage-memory-add "current-project" "sage" 'project)
(sage-memory-add "build-tool" "gmake" 'technical)

;; Start a conversation - AI will know these facts
M-x sage

;; List all facts to review
M-x sage-memory-list

;; Update a fact
(sage-memory-add "current-project" "new-project" 'project)

;; Remove outdated fact
(sage-memory-remove "old-fact")

;; Save manually if auto-save is disabled
M-x sage-memory-save
#+end_src

* Testing

Run the test suite:

#+begin_src emacs-lisp
;; Load tests
(load-file "test/sage-memory-test.el")

;; Run all tests
M-x ert RET t RET

;; Run specific test
M-x ert RET test-memory-add-fact RET
#+end_src

* Advanced Usage

** Custom Categories

While the system validates categories against =sage-memory-categories=, you can extend this:

#+begin_src emacs-lisp
;; Add custom categories (modify before use)
(add-to-list 'sage-memory-categories 'personal)
#+end_src

** Batch Operations

#+begin_src emacs-lisp
;; Add multiple facts
(dolist (fact '(("lang-rust" "Rust" technical)
                ("lang-elisp" "Emacs Lisp" technical)
                ("lang-python" "Python" technical)))
  (apply #'sage-memory-add fact))

;; Export facts to variable
(defvar my-facts (sage-memory-list))
#+end_src

** Conditional Context

#+begin_src emacs-lisp
;; Generate context only for specific categories
(let ((project-facts (sage-memory-list 'project)))
  (when project-facts
    ;; Use project-facts for context
    ...))
#+end_src

* Troubleshooting

** Facts not loading

#+begin_src emacs-lisp
;; Manually load facts
(sage-memory-load)

;; Check file exists
(file-exists-p sage-memory-file)
#+end_src

** Invalid JSON

If the facts file becomes corrupted:

#+begin_src emacs-lisp
;; Backup old file
;; mv ~/.emacs.d/sage/memory/facts.json{,.bak}

;; Clear and start fresh
(setq sage-memory--facts nil
      sage-memory--loaded nil)
#+end_src

* License

Same license as sage (see main package).
