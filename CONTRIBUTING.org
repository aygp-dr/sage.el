#+TITLE: Contributing to sage.el
#+AUTHOR: Jason Walsh
#+EMAIL: j@wal.sh

* Contributing Guidelines

Thank you for your interest in contributing to sage.el! This document provides guidelines for contributing to the project.

** Code of Conduct

By participating in this project, you agree to:
- Be respectful and inclusive
- Welcome newcomers and help them get started
- Focus on constructive criticism
- Respect differing viewpoints and experiences

** How to Contribute

*** Reporting Issues

1. Check existing issues to avoid duplicates
2. Provide detailed information:
   - Emacs version (=M-x emacs-version=)
   - Operating system
   - Steps to reproduce
   - Expected vs actual behavior
   - Error messages (=*Messages*= buffer)

*** Suggesting Features

1. Open an issue or discussion first
2. Explain the use case and benefits
3. Reference similar features in Claude Code or other tools
4. Consider implementation complexity

** Development Setup

*** Prerequisites

- Emacs 28.1+
- =request.el= package
- Git
- Optional: Cask for dependency management

*** Clone and Setup

#+BEGIN_SRC bash
# Clone the repository
git clone https://github.com/aygp-dr/sage.el.git
cd sage.el

# Copy environment template
cp .env.example .env
# Edit .env with your API key

# Run tests to verify setup
make test
#+END_SRC

*** Load for Development

#+BEGIN_SRC elisp
;; Add to load-path (use actual path)
(add-to-list 'load-path "/path/to/sage.el")

;; Load with debugging
(setq debug-on-error t)
(require 'sage)
#+END_SRC

** Coding Standards

*** Emacs Lisp Style

- Use =lexical-binding: t= in all files
- Follow Emacs Lisp conventions (use-hyphens, not CamelCase)
- Prefix public functions with =sage-=
- Prefix private functions with =sage--=
- Use =cl-lib= for Common Lisp utilities
- Document all public functions with docstrings
- Keep lines under 80 characters

*** Example Function

#+BEGIN_SRC elisp
(defun sage-example-function (arg1 arg2)
  "Do something with ARG1 and ARG2.
Returns the result of processing."
  (let ((result (sage--internal-helper arg1)))
    (when arg2
      (setq result (concat result arg2)))
    result))

(defun sage--internal-helper (input)
  "Private helper for processing INPUT."
  (format "processed: %s" input))
#+END_SRC

*** Project Structure

#+BEGIN_EXAMPLE
sage.el              ; Main REPL and provider API
sage-context.el      ; Token counting, context management
sage-emacs.el        ; Org-mode, buffer integrations
sage-memory.el       ; Persistent facts/memory
sage-project.el      ; Per-project conversations
sage-queue.el        ; File-based async queue
sage-ratelimit.el    ; Rate limiting per model
sage-session.el      ; Session save/restore
sage-tools.el        ; File, git, search tools
test/                ; ERT test files
scripts/             ; Helper scripts
#+END_EXAMPLE

** Testing

*** Run Tests

#+BEGIN_SRC bash
# Core tests (fast)
make test

# All tests (90 tests)
make test-all

# Specific module
make test-context
make test-ratelimit
make test-project

# Quick validation
make elisp-load-test    # Verify modules load
make elisp-check-syntax # Byte-compile warnings
#+END_SRC

*** Writing Tests

#+BEGIN_SRC elisp
;;; test/sage-example-test.el -*- lexical-binding: t; -*-

(require 'ert)
(require 'sage-example)

(ert-deftest sage-example-test-basic ()
  "Test basic functionality."
  (should (equal (sage-example-function "a" "b") "processed: ab")))

(ert-deftest sage-example-test-nil-arg ()
  "Test with nil argument."
  (should (equal (sage-example-function "a" nil) "processed: a")))

(provide 'sage-example-test)
#+END_SRC

** Submitting Changes

*** Commit Messages

Use [[https://www.conventionalcommits.org/][Conventional Commits]]:

| Prefix | Description |
|--------+-------------|
| =feat:= | New feature |
| =fix:= | Bug fix |
| =docs:= | Documentation |
| =test:= | Tests |
| =refactor:= | Code restructuring |
| =chore:= | Maintenance |

Examples:
#+BEGIN_EXAMPLE
feat: add /compact command for context summarization
fix: handle nil response from Ollama
docs: add dogfooding quickstart guide
test: add tests for rate limiting edge cases
#+END_EXAMPLE

*** Pull Request Process

1. Fork the repository
2. Create a feature branch:
   #+BEGIN_SRC bash
   git checkout -b feat/my-feature
   #+END_SRC

3. Make changes following coding standards
4. Add/update tests
5. Ensure tests pass:
   #+BEGIN_SRC bash
   make test-all
   #+END_SRC

6. Commit with descriptive message:
   #+BEGIN_SRC bash
   git commit -m "feat: add my feature" \
       --trailer "Co-Authored-By: Your Name <email>"
   #+END_SRC

7. Push and create PR

*** PR Checklist

- [ ] Code follows Elisp style guidelines
- [ ] All tests pass (=make test-all=)
- [ ] New features have tests
- [ ] Public functions have docstrings
- [ ] No byte-compile warnings for new code

** Architecture Overview

*** Provider Abstraction

#+BEGIN_SRC elisp
;; Providers implement these functions:
sage--format-request-TYPE    ; Format request for API
sage--parse-response-TYPE    ; Parse API response
sage--get-endpoint-TYPE      ; Return API endpoint
#+END_SRC

*** Adding a New Provider

1. Add provider to =sage-providers= alist
2. Implement format/parse/endpoint functions
3. Add rate limits to =sage-ratelimit-default-limits=
4. Add tests
5. Update documentation

*** Tool System

#+BEGIN_SRC elisp
;; Register a new tool
(sage-register-tool
 'my-tool
 (lambda (args)
   "Tool implementation"
   (let ((param (alist-get 'param args)))
     (format "Result: %s" param)))
 '((name . "my_tool")
   (description . "Does something useful")
   (parameters . ((type . "object")
                  (properties . ((param . ((type . "string")))))))))
#+END_SRC

** Getting Help

- Open an issue for bugs
- Start a discussion for questions
- Check existing documentation in =*.org= files
- Read the code - it's well-documented

** Recognition

Contributors are recognized in:
- Git commit history
- CHANGES.org for significant contributions
- GitHub contributors page

Thank you for contributing to sage.el!
