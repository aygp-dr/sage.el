#+TITLE: Sage 010 - Elisp Setup and Implementation
#+AUTHOR: AYGP-DR
#+DATE: 2026-01-11
#+PROPERTY: header-args:elisp :tangle yes :mkdirp yes

* Overview

This document contains the setup and implementation guide for sage.el (version 010), an AI coding assistant for Emacs with multi-provider support and tool calling.

This is the Emacs/Elisp counterpart to gemini-repl-009 (Rust).

* Quick Start

** Installation

Clone the repository:

#+BEGIN_SRC bash
git clone https://github.com/aygp-dr/sage.el.git
cd sage.el
#+END_SRC

** Configuration

Add to your Emacs init file:

#+BEGIN_SRC elisp
;; Add to load path
(add-to-list 'load-path "/path/to/sage.el")

;; Load sage
(require 'sage)

;; Configure provider (gemini, ollama, or openai)
(setq sage-provider 'gemini)

;; API keys (or use environment variables)
(setq sage-api-key (getenv "GEMINI_API_KEY"))
;; (setq sage-openai-api-key (getenv "OPENAI_API_KEY"))

;; For Ollama (local models)
;; (setq sage-provider 'ollama)
;; (setq sage-ollama-host "http://localhost:11434")
;; (setq sage-model "llama3.2")
#+END_SRC

** Using use-package

#+BEGIN_SRC elisp
(use-package sage
  :load-path "/path/to/sage.el"
  :custom
  (sage-provider 'gemini)
  (sage-api-key (getenv "GEMINI_API_KEY")))
#+END_SRC

* Project Structure

#+BEGIN_SRC text
sage.el/
├── sage.el              # Main package - REPL, providers, core
├── sage-tools.el        # 26 built-in tools
├── sage-tool-factory.el # Self-extending tool system
├── sage-context.el      # Token counting, context management
├── sage-memory.el       # Persistent facts/memory
├── sage-session.el      # Session save/load
├── sage-project.el      # Project-based conversations
├── sage-queue.el        # File-based async queue
├── sage-ratelimit.el    # Rate limiting with ring buffers
├── sage-emacs.el        # Emacs integrations (org, buffer, dired)
│
├── test/                # ERT test suite
│   ├── sage-test.el
│   ├── sage-tools-test.el
│   ├── sage-stress-test.el
│   └── ...
│
├── examples/            # Demo and example files
│   ├── tool-demos.el
│   └── screencast-demo.el
│
├── scripts/             # Development scripts
│   ├── run-100-scenarios.el
│   └── test-tools.el
│
├── docs/                # Documentation
│   ├── DEMO.org
│   ├── TOOL-AUDIT.org
│   └── TOOL-TEST-PLAN.org
│
└── Makefile             # Build, test, lint targets
#+END_SRC

* Module Dependencies

#+BEGIN_SRC text
sage.el (main)
├── sage-ratelimit.el    ; Rate limiting
├── sage-memory.el       ; Persistent facts
├── sage-session.el      ; Session management
└── sage-context.el      ; Token counting

sage-tools.el
├── sage.el              ; Tool registration
├── [magit]              ; Git operations (required)
└── [org]                ; Org-mode tools (built-in)

sage-emacs.el
├── sage.el              ; Core functionality
└── sage-tools.el        ; Tool access

sage-project.el
├── [projectile]         ; Optional project detection
├── [project.el]         ; Built-in project detection
└── json                 ; JSONL serialization (built-in)
#+END_SRC

* Package Requirements

** Emacs Version

Requires Emacs 28.1 or later for:
- Native compilation support
- project.el improvements
- json.el improvements

** Dependencies

| Package | Required | Purpose |
|---------+----------+---------|
| cl-lib | Built-in | Common Lisp utilities |
| json | Built-in | JSON encoding/decoding |
| url | Built-in | HTTP requests |
| ring | Built-in | Rate limiting buffers |
| org | Built-in | Org-mode tools |
| magit | External | Git operations (required for git tools) |
| projectile | Optional | Enhanced project detection |
| markdown-mode | Optional | Markdown rendering |

Install required packages:

#+BEGIN_SRC elisp
;; Install magit if not present
(unless (package-installed-p 'magit)
  (package-install 'magit))
#+END_SRC

* Configuration Reference

** Core Settings

#+BEGIN_SRC elisp
;; Provider selection
(setq sage-provider 'gemini)     ; 'gemini, 'ollama, or 'openai

;; Model selection (provider-specific defaults if nil)
(setq sage-model nil)            ; e.g., "gemini-2.0-flash-exp"

;; API keys
(setq sage-api-key nil)          ; or GEMINI_API_KEY env var
(setq sage-openai-api-key nil)   ; or OPENAI_API_KEY env var

;; Ollama settings
(setq sage-ollama-host "http://localhost:11434")
#+END_SRC

** Tool Settings

#+BEGIN_SRC elisp
;; Workspace for file operations
(setq sage-workspace nil)        ; defaults to default-directory

;; Skip all permission checks (dangerous!)
(setq sage-yolo-mode nil)

;; Confirm even read-only tools
(setq sage-confirm-safe-tools nil)

;; Maximum tool call iterations
(setq sage-max-tool-iterations 10)
#+END_SRC

** Context Settings

#+BEGIN_SRC elisp
;; Warning threshold (0.0-1.0)
(setq sage-context-warning-threshold 0.80)

;; Compaction threshold
(setq sage-context-compaction-threshold 0.90)

;; Auto-compact when threshold reached
(setq sage-context-auto-compact t)

;; Compaction strategy
(setq sage-context-default-strategy 'sliding-window)
;; Options: 'sliding-window, 'summarization, 'hybrid
#+END_SRC

** Rate Limiting

#+BEGIN_SRC elisp
;; Safety margin (0.9 = use 90% of limit)
(setq sage-ratelimit-safety-margin 0.9)

;; Window size in seconds
(setq sage-ratelimit-window 60)

;; Show countdown when rate limited
(setq sage-ratelimit-show-countdown t)
#+END_SRC

** Project Sessions

#+BEGIN_SRC elisp
;; Storage directory
(setq sage-project-directory
      (expand-file-name "sage/projects" user-emacs-directory))

;; Auto-load project conversation
(setq sage-project-auto-load t)

;; Auto-save each message
(setq sage-project-auto-save t)

;; Max messages before archiving
(setq sage-project-max-messages 1000)
#+END_SRC

* Running Tests

** Quick Test

#+BEGIN_SRC bash
make test
#+END_SRC

** All Tests

#+BEGIN_SRC bash
make test-all
#+END_SRC

** Specific Test Suites

#+BEGIN_SRC bash
make test-ratelimit   # Rate limiting tests
make test-context     # Context management tests
make test-project     # Project session tests
make test-tools-unit  # Tool unit tests
make test-stress      # Stress/edge case tests
#+END_SRC

** Integration Tests

Requires running Ollama:

#+BEGIN_SRC bash
# Start Ollama first
ollama serve &

# Run integration tests
make test-integration
#+END_SRC

** Verify Installation

#+BEGIN_SRC bash
make elisp-load-test
#+END_SRC

* Development

** Code Style

- Use =lexical-binding: t= in all files
- Prefix public functions with =sage-=
- Prefix private functions with =sage--=
- Use =cl-lib= for Common Lisp utilities
- Document all public functions with docstrings
- 80-character line limit

** Tool Development

CRITICAL: Use Emacs primitives, NOT shell commands:

#+BEGIN_SRC elisp
;; WRONG - shell commands fail unpredictably
(shell-command-to-string "rg pattern *.el")
(shell-command-to-string "grep -r pattern .")

;; CORRECT - native primitives
(directory-files-recursively dir "\\.el$")
(string-match-p pattern content)
#+END_SRC

** Adding a New Tool

#+BEGIN_SRC elisp
;; Register in sage-tools.el
(push
 `((name . "my_tool")
   (description . "Description for AI")
   (parameters . ((type . "object")
                  (properties . ((arg1 . ((type . "string")
                                          (description . "First argument")))))
                  (required . ["arg1"])))
   (execute . ,#'sage--tool-my-tool))
 sage-tools)

;; Implement the tool
(defun sage--tool-my-tool (args)
  "Execute my_tool with ARGS."
  (let ((arg1 (alist-get 'arg1 args)))
    ;; Implementation
    (format "Result for %s" arg1)))

;; Add to safe tools list if read-only
(add-to-list 'sage-safe-tools "my_tool")
#+END_SRC

** Linting

#+BEGIN_SRC bash
make lint          # Run all linters
make checkdoc      # Check documentation strings
make check-headers # Check file headers
#+END_SRC

** CI Pipeline

#+BEGIN_SRC bash
make ci            # Full CI pipeline
make gh-status     # Check GitHub Actions status
make gh-logs       # View failed run logs
#+END_SRC

* Provider Reference

** Gemini (Google)

Default model: =gemini-2.0-flash-exp=

Endpoints:
- Generate: =https://generativelanguage.googleapis.com/v1beta/models/{model}:generateContent=

Rate limits (per minute):
| Model | RPM |
|-------+-----|
| gemini-1.5-flash-lite | 30 |
| gemini-1.5-flash | 15 |
| gemini-1.5-pro | 5 |
| gemini-2.0-flash-exp | 10 |

** OpenAI

Default model: =gpt-4o=

Endpoint: =https://api.openai.com/v1/chat/completions=

Rate limits vary by account tier.

** Ollama (Local)

Default model: =llama3.2=

Endpoint: =http://localhost:11434/api/chat=

No rate limits (local execution).

* Storage Locations

| Data | Location |
|------+----------|
| Project conversations | =~/.emacs.d/sage/projects/{encoded-path}/= |
| Memory/facts | =~/.emacs.d/sage/memory/facts.json= |
| Session history | =~/.emacs.d/sage-history= |
| Logs (feat-logging) | =~/.emacs.d/sage/logs/sage.log= |

* Demos

#+BEGIN_SRC bash
make demo            # Interactive GUI demo
make demo-batch      # Batch mode demo
make demo-screencast # Step-by-step screencast
#+END_SRC

* Troubleshooting

** Module Load Errors

#+BEGIN_SRC bash
make elisp-load-test
#+END_SRC

** Magit Not Found

#+BEGIN_SRC elisp
(package-install 'magit)
#+END_SRC

** API Key Issues

#+BEGIN_SRC bash
# Verify environment variable
echo $GEMINI_API_KEY

# Or set in Emacs
M-x setenv RET GEMINI_API_KEY RET <your-key>
#+END_SRC

** Rate Limiting

#+BEGIN_SRC elisp
;; Check status
M-x sage-ratelimit-status

;; Reset if stuck
M-x sage-ratelimit-reset
#+END_SRC

* Migration from Rust (009)

This Elisp implementation (010) is a port from the Rust implementation (009).

| Feature | Rust (009) | Elisp (010) |
|---------+------------+-------------|
| REPL | rustyline | comint-mode |
| HTTP | reqwest | url.el |
| Async | tokio | synchronous |
| Config | TOML | defcustom |
| Tools | Trait-based | Alist-based |
| Storage | File-based | File-based |

Key differences:
- Elisp uses synchronous HTTP (no streaming yet)
- Configuration via =defcustom= instead of TOML files
- Direct Emacs integration (buffers, org-mode, etc.)
- Tool system uses alists instead of Rust traits
- Rate limiting uses Emacs ring buffers

* See Also

- README.org - User documentation
- CONTRIBUTING.org - Contribution guide
- AGENTS.md - Agent coordination patterns
- docs/DEMO.org - Interactive demo
- docs/TOOL-AUDIT.org - Tool implementation status
