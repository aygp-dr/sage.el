#+TITLE: Project Sessions Feature Addition
#+DATE: 2024-12-23

* Overview

Added comprehensive project-based session management to sage-010,
enabling per-directory conversation history with automatic persistence and
archiving capabilities.

* Files Added

** Core Implementation
- =sage-project.el= (585 lines)
  - Per-directory conversation storage using JSONL format
  - Path encoding matching Claude Code's approach (/ → -)
  - Auto-load and auto-save functionality
  - Project metadata tracking
  - Archive management
  - Integration with project.el, projectile, and git

** Tests
- =test/sage-project-test.el= (147 lines)
  - Path encoding tests
  - Message creation and storage tests
  - Metadata tests
  - Integration tests
  - File path tests

** Documentation
- =PROJECT-SESSIONS.org= (397 lines)
  - Comprehensive usage guide
  - Storage structure documentation
  - Configuration examples
  - Workflow examples
  - Troubleshooting guide
  - Integration examples

** Examples
- =examples/project-sessions-example.el= (331 lines)
  - 10 detailed usage examples
  - Multi-project workflow
  - Archiving strategies
  - Custom metadata tracking
  - org-mode integration
  - Git branch-based sessions

** Documentation Updates
- =README.org=
  - Added Project-Based Conversations section
  - Updated feature list
  - Added configuration examples

* Features

** Storage
- JSONL format for efficient append-only operations
- One message per line for easy parsing
- Separate metadata.json file
- Organized history/ directory for archives

** Path Encoding
- Safe directory name generation from project paths
- Replaces "/" with "-" (matches Claude Code)
- Example: /home/user/project → -home-user-project

** Functions Provided

*** Core Operations
- =sage-project-load= - Load project conversation
- =sage-project-append= - Append message to conversation
- =sage-project-clear= - Clear conversation (with archiving)
- =sage-project-save= - Manual save (auto-save by default)

*** Archive Management
- =sage-project-archive= - Archive current conversation
- =sage-project-list-archives= - List all archives
- =sage-project-load-archive= - Load archived conversation

*** Metadata
- =sage-project-metadata= - Get/set project metadata
- Supports custom fields
- Automatic tracking of creation/update times, message counts

*** Utilities
- =sage-project-stats= - Display conversation statistics
- =sage-project-export= - Export to JSON or Markdown
- =sage-project-dir= - Get current project root
- =sage-project-set-dir= - Manually set project directory

** Project Detection

Supports multiple backends:
1. projectile (if preferred and available)
2. project.el (Emacs built-in)
3. Git repository root
4. Current directory (fallback)

** Auto-Features

- Auto-load: Automatically loads conversation on REPL start
- Auto-save: Saves each message immediately after appending
- Auto-archive: Archives old messages when limit exceeded
- Configurable thresholds and behavior

** Export Formats

- JSON: Pretty-printed with project metadata
- Markdown: Formatted conversation with headers and timestamps

* Configuration Variables

- =sage-project-directory= - Storage location
- =sage-project-auto-load= - Enable auto-load
- =sage-project-auto-save= - Enable auto-save
- =sage-project-max-messages= - Message limit before auto-archive
- =sage-project-prefer-projectile= - Prefer projectile over project.el

* Message Format

Each message stored as JSON with:
- =role= - "user" or "assistant"
- =content= - Message text
- =timestamp= - ISO 8601 timestamp

Example:
#+begin_src json
{"role":"user","content":"How do I optimize this?","timestamp":"2024-12-23T14:30:00-0500"}
#+end_src

* Metadata Format

Project metadata includes:
- =project_dir= - Project directory path
- =created_at= - Creation timestamp
- =updated_at= - Last update timestamp
- =message_count= - Number of messages
- =total_size= - File size in bytes
- Custom fields (user-defined)

* Use Cases

** Daily Development
- Continuous conversation context per project
- Automatic persistence across Emacs sessions
- History of all interactions

** Multi-Project Work
- Switch between projects, conversations automatically switch
- Isolated context per project
- No cross-contamination

** Long-Running Conversations
- Auto-archive prevents memory bloat
- Keep recent messages accessible
- Historical archive for reference

** Team Collaboration
- Export conversations for sharing
- Markdown format for documentation
- Git-friendly JSONL format

** Research and Learning
- Track questions and answers per project
- Export to org-mode for notes
- Search conversation history

* Integration Examples

** Basic Setup
#+begin_src elisp
(require 'sage-project)

(setq sage-project-auto-load t)
(setq sage-project-auto-save t)

;; Hook into REPL startup
(add-hook 'sage-mode-hook
          (lambda ()
            (when sage-project-auto-load
              (sage-project-load))))
#+end_src

** Git Integration
#+begin_src elisp
;; Store git context in metadata
(defun my-save-git-context ()
  (when-let ((rev (vc-git-working-revision default-directory)))
    (sage-project-metadata :git_commit rev)))

(add-hook 'sage-mode-hook #'my-save-git-context)
#+end_src

** Weekly Archiving
#+begin_src elisp
;; Archive conversations weekly
(run-at-time "00:00 Mon" (* 7 24 60 60)
             (lambda ()
               (sage-project-archive
                (format-time-string "week-%Y-w%U"))))
#+end_src

* Testing

Run tests with:
#+begin_src elisp
(load-file "test/sage-project-test.el")
(ert t)
#+end_src

* Future Enhancements

Potential future additions:
- Conversation search with full-text indexing
- Conversation merging and splitting
- Export to additional formats (HTML, PDF)
- Cloud sync support
- Conversation analytics (sentiment, topics)
- Integration with other Emacs packages (org-roam, etc.)
- Conversation templates
- Multi-user conversations (pair programming)

* Technical Notes

** Design Decisions

1. *JSONL over JSON*: Append-only format for efficiency
2. *Path encoding*: Simple, readable, matches Claude Code
3. *Separate metadata*: Fast access without parsing conversation
4. *Auto-archive*: Prevents performance degradation
5. *Multiple project backends*: Flexibility for different workflows

** Performance Considerations

- JSONL append is O(1)
- Loading conversation is O(n) where n = message count
- Auto-archive triggers at configurable threshold
- Metadata updates are atomic

** Safety

- No destructive operations without confirmation
- Archives created before clearing
- All files stored in user's home directory
- No external dependencies beyond Emacs

* Credits

Implementation follows the design patterns from:
- Claude Code (path encoding approach)
- sage-session.el (session management patterns)
- sage-memory.el (persistent storage patterns)
