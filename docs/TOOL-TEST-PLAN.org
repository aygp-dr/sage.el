#+TITLE: sage-tools.el Test Plan
#+AUTHOR: sage.el Team
#+DATE: 2026-01-11

* Overview

Comprehensive test plan for all tools in sage-tools.el.
Each tool is tested in isolation with mocked dependencies.

* Test Categories

** Unit Tests (test/sage-tools-test.el)

All 22 tests pass as of 2026-01-11.

| Test Category        | Count | Status |
|----------------------+-------+--------|
| File Tools           |     5 | ✅      |
| Search Tools         |     4 | ✅      |
| Org-mode Tools       |     4 | ✅      |
| Web Tools            |     5 | ✅      |
| Tool Init            |     1 | ✅      |
| Edge Cases           |     2 | ✅      |
| Safe Tools           |     1 | ✅      |

** Test Fixtures

#+begin_src elisp
;; Temporary workspace setup
(defun sage-tools-test--setup ()
  (setq sage-tools-test--temp-dir (make-temp-file "sage-tools-test-" t))
  (setq sage-workspace sage-tools-test--temp-dir))

;; URL mocking for web tools
(defmacro sage-tools-test--with-mock-url (url-responses &rest body)
  "Execute BODY with mocked URL responses."
  ...)
#+end_src

* Tool-by-Tool Test Plan

** FILE TOOLS

*** read_file
- [X] Read existing file → returns contents
- [X] Read non-existent file → returns error message
- [ ] Read binary file → handled gracefully
- [ ] Read large file → truncates or streams

*** write_file
- [X] Write new file → creates file with content
- [ ] Overwrite existing → replaces content
- [ ] Write to read-only location → returns error

*** list_files
- [X] List with glob pattern → filters correctly
- [ ] List empty directory → returns empty
- [ ] List non-existent directory → returns error

*** edit_file
- [X] Replace existing text → modifies file
- [ ] Text not found → returns error message
- [ ] Multiple matches → only replaces first

** SEARCH TOOLS

*** code_search
- [X] Search with file type filter → finds matches
- [X] Search without file type → searches all files
- [X] No matches → returns "No matches" message
- [X] Binary files → skipped automatically
- [ ] Regex patterns → work correctly
- [ ] Large repositories → respects file limit (100)

*** glob_files
- [X] Glob pattern → returns matching files
- [ ] Recursive patterns (**/) → work correctly

*** search_preview
- [ ] Context lines → shows surrounding context
- [ ] Multiple matches in file → shows all

** GIT TOOLS

*** git_status
- [ ] Clean repo → empty result
- [ ] Modified files → shows status
- [ ] Uses magit if available → falls back to shell

*** git_diff
- [ ] Staged changes → shows diff
- [ ] Unstaged changes → shows diff
- [ ] Path filter → limits to file

*** git_log
- [ ] Default count → returns 10 commits
- [ ] Custom count → returns specified number
- [ ] Path filter → shows file history

*** git_branch
- [ ] All branches → lists local and remote

*** git_blame
- [ ] Valid file → shows blame
- [ ] Invalid file → returns error

** ORG-MODE TOOLS

*** org_todo_list
- [X] List from file → extracts TODOs with state
- [X] File not found → returns error
- [ ] Agenda files → aggregates from multiple files
- [ ] Priority parsing → shows [#A], [#B], [#C]
- [ ] Tags → includes in output

*** org_add_todo
- [X] Add TODO → appends to file
- [X] Unsafe path → rejected
- [ ] With priority → includes priority
- [ ] Custom state → uses specified state

*** org_set_todo_state
- [ ] Change state → updates file
- [ ] Heading not found → returns error

** WEB TOOLS

*** web_fetch
- [X] Valid URL → returns content
- [X] Invalid URL → returns error
- [X] HTML entities → decoded
- [X] Script tags → removed
- [ ] Timeout → respected
- [ ] Redirect → followed

*** web_search
- [X] Valid query → returns results
- [X] No query → returns error
- [ ] Max results → limits output
- [ ] Special characters → URL-encoded

** EMACS-SPECIFIC TOOLS

*** eval_elisp
- [ ] Valid code → returns result
- [ ] Error in code → returns error message
- [ ] Security → sandbox considerations

*** describe_function
- [ ] Known function → returns documentation
- [ ] Unknown function → returns error

*** describe_variable
- [ ] Known variable → returns documentation
- [ ] Unknown variable → returns error

*** find_definition
- [ ] Symbol found → returns location
- [ ] Symbol not found → returns error

*** list_buffers
- [ ] Multiple buffers → lists all

*** switch_buffer
- [ ] Existing buffer → switches
- [ ] Non-existent → returns error

*** insert_at_point
- [ ] Current buffer → inserts text
- [ ] Named buffer → inserts in specified

** SELF-AWARENESS TOOLS

*** project_map
- [ ] In project → returns structure
- [ ] Not in project → returns message

*** get_capabilities
- [ ] Lists all tools → complete list
- [ ] Shows features → magit, xref, etc.

* Mock Dependencies

** URL Mocking

#+begin_src elisp
(defvar sage-tools-test--url-responses nil)

(defun sage-tools-test--mock-url-retrieve (url &rest _args)
  "Mock url-retrieve-synchronously."
  (let ((response (alist-get url sage-tools-test--url-responses ...)))
    (when response
      (let ((buf (generate-new-buffer " *mock-url*")))
        (with-current-buffer buf
          (insert "HTTP/1.1 200 OK\n\n")
          (insert response))
        buf))))
#+end_src

** Org-mode Mocking

Tests use real org-mode when available (=skip-unless=).
Org functions tested:
- =org-map-entries=
- =org-get-heading=
- =org-get-todo-state=
- =org-entry-get=
- =org-get-tags=
- =org-todo=

* Running Tests

#+begin_src bash
# All tool tests
emacs --batch -L . -l ert -l sage-tools.el \
  -l test/sage-tools-test.el \
  -f ert-run-tests-batch-and-exit

# Single test
emacs --batch -L . -l ert -l sage-tools.el \
  -l test/sage-tools-test.el \
  --eval "(ert-run-tests-batch-and-exit 'sage-tools-test-read-file)"

# Pattern match
emacs --batch -L . -l ert -l sage-tools.el \
  -l test/sage-tools-test.el \
  --eval "(ert-run-tests-batch-and-exit \"web\")"
#+end_src

* Code Review Checklist

** Emacs Master Review
- [ ] Elisp conventions followed
- [ ] Proper use of =cl-lib= functions
- [ ] =lexical-binding= throughout
- [ ] Declare functions for optional deps
- [ ] No byte-compile warnings
- [ ] Buffer/file handling best practices

** L7/Terminal Agent Review
- [ ] Tool schemas match MCP spec
- [ ] Error messages actionable for LLM
- [ ] Tool descriptions clear for model
- [ ] Safe tools list correct
- [ ] Confirmation flow appropriate

** CTO Review
- [ ] Security: path traversal prevention
- [ ] Security: no code injection
- [ ] Architecture: extensibility
- [ ] Architecture: modular design
- [ ] Performance: file limits
- [ ] Performance: timeout handling

* Stress Test Scenarios (test/sage-stress-test.el)

** SCENARIO 1: Large File Handling
- [X] Read 10MB file → should truncate/handle gracefully
- [X] Write 1MB file → should complete successfully
- [ ] Read file with very long lines (10K+ chars)
- [ ] Read file with many small lines (100K lines)

** SCENARIO 2: Many Files
- [X] List directory with 1000 files → should complete
- [X] Code search across 500 files → should find matches
- [ ] Glob with 10K files → performance check
- [ ] Recursive search in 100+ directories

** SCENARIO 3: Security Boundary Tests
- [X] Path traversal variants (../, ..\, %2e, etc.)
- [X] Write path traversal attacks
- [ ] Command injection in filenames
- [ ] Symlink escapes
- [ ] Race condition (TOCTOU)

** SCENARIO 4: Special Characters
- [X] Unicode filenames (Japanese, Cyrillic)
- [X] Special chars in content (null, CR, LF, tab)
- [ ] Emoji in filenames and content
- [ ] Non-UTF8 byte sequences

** SCENARIO 5: Nested Structures
- [X] Deep nesting (10 levels) → should work
- [ ] Very long paths (approaching OS limits)
- [ ] Mixed absolute/relative paths

** SCENARIO 6: Concurrent Operations
- [X] 100 rapid sequential read/write operations
- [ ] Interleaved read/write on same file
- [ ] Multiple code_search calls

** SCENARIO 7: Edit Edge Cases
- [X] Edit first line of file
- [X] Edit last line of file
- [X] Edit with empty strings
- [X] Edit multiline text blocks
- [ ] Edit text that appears multiple times
- [ ] Edit text spanning the entire file

** SCENARIO 8: Glob Edge Cases
- [X] Hidden files (.hidden)
- [X] Recursive patterns (**/*)
- [ ] Negation patterns
- [ ] Character classes [a-z]

** SCENARIO 9: Tool Call Counting
- [X] Count tool invocations in test suite
- [ ] Verify all 26 tools are tested
- [ ] Track coverage per tool

** SCENARIO 10: Error Recovery
- [X] Multiple errors don't corrupt state
- [ ] Partial writes rollback
- [ ] Interrupted operations cleanup

** Performance Benchmarks
- [X] Read benchmark: 100 ops in <5s
- [X] Write benchmark: 50 ops in <5s
- [ ] Search benchmark: 1000 files in <10s
- [ ] Edit benchmark: 100 ops in <5s

* Logging Integration (feat-logging branch)

** Log Event Types
The =sage-log.el= module tracks:

| Event Type | Level | Data Fields |
|------------+-------+-------------|
| request    | info  | provider, model, prompt |
| response   | info  | provider, model, response, tokens, duration |
| tool_call  | info  | tool, args, result, error |
| error      | error | message, context, backtrace |
| warning    | warn  | message, context |

** Log Analysis Queries

#+begin_src bash
# Count tool calls by type
cat ~/.emacs.d/sage/logs/sage.log | \
  jq -r 'select(.event == "tool_call") | .data.tool' | \
  sort | uniq -c | sort -rn

# Find slow operations (>1s)
cat ~/.emacs.d/sage/logs/sage.log | \
  jq 'select(.event == "response" and .data.duration_ms > 1000)'

# Count errors
cat ~/.emacs.d/sage/logs/sage.log | \
  jq -r 'select(.level == "error") | .data.message' | \
  sort | uniq -c

# Tool usage over time
cat ~/.emacs.d/sage/logs/sage.log | \
  jq -r 'select(.event == "tool_call") | "\(.timestamp) \(.data.tool)"'
#+end_src

** Expected Tool Call Distribution (based on Claude Code analysis)

| Tool Category | Approx % | Primary Tools |
|--------------+---------+---------------|
| Bash/Shell    | 53%      | eval_elisp (proxy) |
| Read          | 18%      | read_file, org_todo_list |
| Edit          | 16%      | edit_file, write_file |
| Search        | 8%       | code_search, glob_files |
| Git           | 3%       | git_status, git_diff |
| Other         | 2%       | web_fetch, describe_* |

* Future Tests

** Integration Tests
- Live Ollama testing (test/sage-integration-test.el)
- Live Gemini testing
- Real web fetch testing
- Project session persistence
- Rate limiting behavior

** Property-based Tests
- Random file paths → safe-path-p
- Random search patterns → code_search
- Random org content → org tools
- Random edit positions → edit_file

** Coverage Goals

| Module | Target | Current |
|--------+--------+---------|
| sage-tools.el | 90% | ~75% |
| sage-context.el | 80% | ~60% |
| sage-ratelimit.el | 85% | ~70% |
| sage-project.el | 80% | ~50% |
| sage-memory.el | 85% | ~65% |
| sage-session.el | 80% | ~55% |

** Missing Tool Tests

Tools not yet in test suite:
- [ ] org_close_todo
- [ ] org_archive_todo
- [ ] search_preview
- [ ] git_status
- [ ] git_diff
- [ ] git_log
- [ ] git_branch
- [ ] git_blame
- [ ] eval_elisp
- [ ] describe_function
- [ ] describe_variable
- [ ] find_definition
- [ ] list_buffers
- [ ] switch_buffer
- [ ] insert_at_point
- [ ] project_map
- [ ] get_capabilities
